<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QUEST</title>
  <style>
    :root{
      color-scheme: dark;

      --bg0:#0b0f1a;
      --bg1:#0f1730;

      --card:rgba(18,27,52,.78);
      --card2:rgba(17,25,45,.72);
      --stroke:rgba(255,255,255,.10);
      --text:#e9edf7;
      --muted:rgba(233,237,247,.72);

      --gold:#ffd58a;
      --gold2:#f4b84a;
      --emerald:#6fe7b9;
      --ruby:#ff6b6b;
      --sky:#7db3ff;

      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(255,213,138,.10), transparent 60%),
        radial-gradient(900px 520px at 80% 20%, rgba(125,179,255,.10), transparent 65%),
        radial-gradient(900px 520px at 50% 90%, rgba(111,231,185,.08), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      min-height:100vh;
    }

    .wrap{max-width:1120px;margin:0 auto;padding:22px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--stroke);border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      position:sticky;top:10px;backdrop-filter: blur(10px);
      z-index:3;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .crest{
      width:40px;height:40px;border-radius:14px;
      background:
        radial-gradient(18px 18px at 28% 30%, rgba(255,255,255,.18), transparent 70%),
        linear-gradient(135deg, rgba(255,213,138,.75), rgba(125,179,255,.65));
      border:1px solid rgba(255,255,255,.18);
      display:grid;place-items:center;
      box-shadow:0 12px 28px rgba(0,0,0,.35);
    }
    .crest svg{opacity:.95}
    .title h1{margin:0;font-size:15px;letter-spacing:.45px}
    .title p{margin:2px 0 0;color:var(--muted);font-size:12px}

    .actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      padding:14px;
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;inset:-1px;
      background:
        radial-gradient(600px 220px at 20% 0%, rgba(255,213,138,.10), transparent 50%),
        radial-gradient(500px 250px at 90% 10%, rgba(125,179,255,.08), transparent 55%);
      opacity:.65;pointer-events:none;
    }
    .card > *{position:relative; z-index:1;}

    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .h2{margin:0 0 8px;font-size:14px}
    .sub{margin:0 0 10px;font-size:12px;color:var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:10px 0}

    .profileTop{display:flex;gap:12px;align-items:center}
    .avatar{
      width:54px;height:54px;border-radius:18px;
      background:linear-gradient(135deg, rgba(244,184,74,.25), rgba(125,179,255,.12));
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 14px 30px rgba(0,0,0,.35);
      display:grid;place-items:center;
      overflow:hidden;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .nameBlock b{font-size:15px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{
      padding:6px 9px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-size:12px;
      display:inline-flex;align-items:center;gap:6px;
      font-weight:800;
    }
    .chip.gold{border-color:rgba(244,184,74,.35);background:rgba(244,184,74,.12)}
    .chip.good{border-color:rgba(111,231,185,.35);background:rgba(111,231,185,.10)}
    .chip.warn{border-color:rgba(255,213,138,.35);background:rgba(255,213,138,.10)}
    .chip.bad{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.10)}

    .statGrid{
      display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
      margin-top:10px;
    }
    @media (max-width: 700px){
      .statGrid{grid-template-columns:repeat(2,1fr)}
    }
    .stat{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px;
    }
    .stat .k{font-size:11px;color:var(--muted)}
    .stat .v{font-size:15px;font-weight:900;margin-top:2px}

    .stat.small{padding:9px;border-radius:16px}
    .stat.small .k{font-size:11px}
    .stat.small .v{font-size:14px}

    /* ===== Livro: cap√≠tulos (scroll interno no modal) ===== */
    .chList{
      display:grid;gap:8px;margin-top:10px;
      max-height:220px; overflow:auto;
      padding-right:6px;
      scrollbar-width:thin;
      scrollbar-color: rgba(255,255,255,.18) rgba(0,0,0,.10);
    }
    .chList::-webkit-scrollbar{width:10px}
    .chList::-webkit-scrollbar-track{background:rgba(0,0,0,.12);border-radius:999px}
    .chList::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.14);
      border-radius:999px;
      border:2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }
    .chList::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.20);background-clip: padding-box}

    .chItem{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      border-radius:16px;
      padding:10px;
    }
    .chTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .chTitle{font-weight:950;font-size:13px;line-height:1.25}
    .chSub{margin-top:4px;font-size:12px;color:var(--muted)}

    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);overflow:hidden}
    .bar i{display:block;height:100%;width:0%;background:linear-gradient(90deg, rgba(244,184,74,.85), rgba(125,179,255,.85))}
    .bar i.good{background:linear-gradient(90deg, rgba(111,231,185,.9), rgba(125,179,255,.75))}
    .barLabel{display:flex;justify-content:space-between;gap:10px;margin-top:6px;font-size:12px;color:var(--muted)}
    .sectionTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .sectionTitle .left{display:flex;align-items:center;gap:10px}

    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .select{
      -webkit-appearance:none;
      appearance:none;
      color-scheme: dark;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(10,14,28,.55);
      color:var(--text);
      border-radius:14px;
      padding:9px 34px 9px 10px;
      font-weight:800;font-size:12px;
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      background-image:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0)),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none'><path d='M7 10l5 5 5-5' stroke='rgba(233,237,247,0.85)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>");
      background-repeat:no-repeat,no-repeat;
      background-position:0 0, right 10px center;
      transition: border-color .2s ease, background .2s ease, transform .08s ease;
      cursor:pointer;
    }
    .select:hover{background:rgba(10,14,28,.62);border-color:rgba(255,255,255,.18)}
    .select:focus{border-color:rgba(255,213,138,.30); box-shadow:0 0 0 3px rgba(244,184,74,.12)}
    option{background-color:#0f1730;color:var(--text);}

    .bookGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:10px}
    @media (max-width: 980px){ .bookGrid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 620px){ .bookGrid{grid-template-columns:1fr} }

    .book{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      border-radius:18px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, border-color .2s ease, background .2s ease;
    }
    .book:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18);background:rgba(0,0,0,.20)}
    .cover{height:82px;border-bottom:1px solid rgba(255,255,255,.10)}
    .bookBody{padding:10px}
    .bookTitle{margin:0;font-weight:950;font-size:13px;line-height:1.2}
    .bookMeta{margin:4px 0 8px;color:var(--muted);font-size:12px}
    .miniRow{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:8px}
    .tagRow{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .tag{padding:4px 7px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:11px;color:var(--muted)}
    .badge{padding:4px 7px;border-radius:999px;font-weight:900;font-size:11px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06)}
    .badge.good{border-color:rgba(111,231,185,.35);background:rgba(111,231,185,.10)}
    .badge.warn{border-color:rgba(255,213,138,.35);background:rgba(255,213,138,.10)}
    .badge.bad{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.10)}

    .achList{display:grid;gap:10px;margin-top:10px}

    /* ===== Atividade recente (Leitura x Quest√µes) ===== */
    .splitGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;position:relative}
    .splitGrid:before{content:"";position:absolute;left:50%;top:10px;bottom:10px;width:1px;background:rgba(255,255,255,.08)}
    .splitPane{border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.10);border-radius:16px;padding:12px}
    .scrollBox{max-height:420px;overflow:auto;padding-right:6px}
    .scrollBox::-webkit-scrollbar{width:8px}
    .scrollBox::-webkit-scrollbar-thumb{background:rgba(255,255,255,.10);border-radius:999px}
    .themesRow{display:flex;gap:8px;flex-wrap:wrap}
    .themesRow .tag{font-size:11px}
    .qSnippet{margin-top:8px;font-size:12px;color:rgba(233,237,247,.70);white-space:pre-wrap}
    @media (max-width: 900px){
      .splitGrid{grid-template-columns:1fr}
      .splitGrid:before{display:none}
      .scrollBox{max-height:360px}
    }

    .ach{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      border-radius:16px;
      padding:10px;
    }
    .ach b{font-size:13px}
    .ach .d{font-size:12px;color:var(--muted);margin-top:3px}
    .ach .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    .empty{
      padding:14px;border-radius:16px;border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.12);color:var(--muted);font-size:12px;
    }

    /* ===== Conquistas: trava o card e faz o conte√∫do rolar DENTRO do quadrado ===== */
    #achCard{display:flex;flex-direction:column}
    #achCard .sectionTitle, #achCard .sub{flex:0 0 auto}
    #achList{
      flex:1 1 auto;
      min-height:0; /* ESSENCIAL para scroll funcionar dentro de flex */
      overflow:auto;
      padding-right:6px;
      scrollbar-width:thin;
      scrollbar-color: rgba(255,255,255,.18) rgba(0,0,0,.10);
    }
    #achList::-webkit-scrollbar{width:10px}
    #achList::-webkit-scrollbar-track{background:rgba(0,0,0,.12);border-radius:999px}
    #achList::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.14);
      border-radius:999px;
      border:2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }
    #achList::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.20);background-clip: padding-box}

    /* Modal (painel mais s√≥lido, menos ‚Äúfantasma‚Äù) */
    .backdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,.70);
      backdrop-filter: blur(6px);
      display:none;align-items:center;justify-content:center;
      padding:16px;z-index:9;
    }
    .modal{
      width:min(760px, 100%);
      max-height: calc(100vh - 32px);
      display:flex;
      flex-direction:column;
      border-radius:12px; /* mais ‚Äúpainel‚Äù */
      border:1px solid rgba(255,213,138,.16);
      background:
        radial-gradient(520px 220px at 20% 0%, rgba(255,213,138,.10), transparent 55%),
        radial-gradient(520px 260px at 90% 10%, rgba(125,179,255,.08), transparent 60%),
        rgba(10,14,25,.96);
      box-shadow:0 28px 120px rgba(0,0,0,.70);
      overflow:hidden;
      position:relative;
    }
    .modal::before{
      content:"";
      position:absolute;inset:8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.06);
      pointer-events:none;
    }
    .modalHead{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;padding:14px 14px 0;position:relative}
    .modalBody{padding:10px 14px 14px;position:relative;overflow:auto;flex:1 1 auto;min-height:0}
    .x{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900
    }
    .x:hover{background:rgba(255,255,255,.10)}
    .review{white-space:pre-wrap;line-height:1.45;color:rgba(233,237,247,.90);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="crest" aria-hidden="true">
          <!-- √çcone: livro medieval (leve, estilo √≠cone) -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M6.5 4.8c1.8-.9 4.6-.9 6.4 0" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
            <path d="M6.2 5.6v13.7c0 .9.9 1.5 1.7 1.1 1.6-.8 4.2-.8 5.8 0 .8.4 1.7-.2 1.7-1.1V5.6" stroke="white" stroke-width="1.8" stroke-linejoin="round"/>
            <path d="M6.2 8.1h9.2" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
            <path d="M14.8 5.6c.9-.4 2.1-.7 3.1-.7.9 0 1.9.2 2.5.5v13.6c-.7-.3-1.6-.4-2.5-.4-1 0-2.2.2-3.1.6" stroke="white" stroke-width="1.8" stroke-linejoin="round"/>
            <path d="M17.9 9.2v5.1" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="title">
          <h1>QUEST</h1>
          <p>Acervo Medieval</p>
        </div>
      </div>

      <div class="actions">
        <span class="chip" title="P√°gina somente leitura (carrega automaticamente o public.json).">üìú Somente leitura</span>
      </div>
    </header>

    <div class="card" style="margin-top:14px;">
      <div class="row">
        <div>
          <h2 class="h2">üìú Sobre o QUEST</h2>
          <p class="sub">
            O <b>QUEST</b> √© um <b>RPG de leitura/estudo</b>: serve para registrar livros, cap√≠tulos e t√≥picos, acompanha progresso,
            finaliza livros e ganha <b>medalhas</b> e <b>conquistas</b> por isso. Este acervo foi criado para mostrar minha cole√ß√£o ao longo do tempo.
          </p>
        </div>
        <div class="chips">
          <!-- Mostra apenas em erro (quando estiver ok, fica oculto) -->
          <span class="chip warn" id="statusChip" style="display:none;">Carregando public.json‚Ä¶</span>
          <label class="chip" id="loadLocalChip" style="display:none; cursor:pointer;" title="Carregar public.json manualmente (√∫til ao abrir este HTML direto pelo disco).">üìÑ Carregar public.json<input id="localPublicFile" type="file" accept="application/json" style="display:none" /></label>
        </div>
      </div>
    </div>

    <div class="grid">
      <section class="card" id="profileCard">
        <div class="sectionTitle">
          <div class="left">
            <h2 class="h2" style="margin:0">üõ°Ô∏è Perfil do Jogador</h2>
            <span class="chip gold" id="rankTitle">‚Äî</span>
          </div>
          <span class="chip good" id="medalsChip">üèÖ 0</span>
        </div>
        <p class="sub" id="tagline">‚Äî</p>

        <div class="profileTop">
          <div class="avatar" id="avatarBox">üë§</div>
          <div class="nameBlock">
            <b id="playerName">Jogador</b>
            <div class="chips" style="margin-top:8px">
              <span class="chip" id="rankBooks">üìö Rank: ‚Äî</span>
              <span class="chip" id="rankMedals">üèµÔ∏è Medalhas: ‚Äî</span>
              <span class="chip" id="goalChip">üéØ Meta: ‚Äî</span>
            </div>
          </div>
        </div>

        <div class="statGrid" id="statGrid"></div>
        <div class="statGrid" id="qStatGrid" style="margin-top:10px; display:none;"></div>

        <div class="hr"></div>

        <div style="display:grid; gap:12px;">
          <div>
            <div class="row">
              <b>üìö Rank por livros</b>
              <span class="muted" id="booksLine">‚Äî</span>
            </div>
            <div class="bar" style="margin-top:8px;"><i id="booksBar"></i></div>
            <div class="barLabel"><span id="booksNote">‚Äî</span><span id="booksPct">0%</span></div>
          </div>

          <div>
            <div class="row">
              <b>üèÖ Rank por medalhas</b>
              <span class="muted" id="medalsLine">‚Äî</span>
            </div>
            <div class="bar" style="margin-top:8px;"><i id="medalsBar" class="good"></i></div>
            <div class="barLabel"><span id="medalsNote">‚Äî</span><span id="medalsPct">0%</span></div>
          </div>
        </div>
      </section>

      <section class="card" id="achCard">
        <div class="sectionTitle">
          <div class="left">
            <h2 class="h2" style="margin:0">üèÜ Conquistas</h2>
          </div>
          <div class="filters">
            <select class="select" id="achFilter" aria-label="Filtro de conquistas">
              <option value="all">Todas</option>
              <option value="unlocked">Apenas destravadas</option>
              <option value="locked">Apenas bloqueadas</option>
            </select>
          </div>
        </div>
        <p class="sub">Conquistas autom√°ticas (do jogo) + conquistas manuais (suas). ‚ÄúTodas‚Äù inclui bloqueadas.</p>
        <div id="achList" class="achList"></div>
      </section>
    </div>

    <section class="card" style="margin-top:14px;">
      <div class="sectionTitle">
        <div class="left">
          <h2 class="h2" style="margin:0">üìö Cole√ß√£o</h2>
          <span class="chip" id="collectionCount">0 livros</span>
        </div>
        <div class="filters">
          <select class="select" id="bookFilter" aria-label="Filtro de livros">
            <option value="all">Todos</option>
            <option value="progress">Em progresso</option>
            <option value="done">Finalizados</option>
          </select>
          <select class="select" id="tagFilter" aria-label="Filtro de tags">
            <option value="">(todas as tags)</option>
          </select>
        </div>
      </div>
      <p class="sub">Clique em um livro para ver detalhes (progresso, tags, estrelas e review se finalizado).</p>
      <div id="bookGrid" class="bookGrid"></div>
    </section>

    <section class="card" id="activityCard" style="margin-top:14px; display:none;">
      <div class="sectionTitle">
        <div class="left">
          <h2 class="h2" style="margin:0">üß≠ Atividade recente</h2>
        </div>
      </div>
      <!--
      <p class="sub">Leitura (sess√µes) √† esquerda ‚Ä¢ Quest√µes resolvidas √† direita. Listas com scroll interno (at√© 20 + 20).</p>
      -->
      <div class="splitGrid">
        <div class="splitPane">
          <div class="row">
            <b>üìö Leitura</b>
            <span class="muted" id="readingCount">‚Äî</span>
          </div>
          <div class="scrollBox" style="margin-top:10px;">
            <div id="readingList" class="achList"></div>
          </div>
        </div>

        <div class="splitPane">
          <div class="row">
            <b>üß© Quest√µes recentes</b>
          </div>
          <div class="themesRow" id="qThemesRow" style="margin-top:8px; display:none;"></div>
          <div class="scrollBox" style="margin-top:10px;">
            <div id="qRecentList" class="achList"></div>
          </div>
        </div>
      </div>
    </section>
    <!--
    <p class="muted" style="text-align:center; margin:16px 0 6px; font-size:12px;">
      Feitosa_exe
    </p>
    -->
  </div>

  <div class="backdrop" id="backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Detalhes do livro">
      <div class="modalHead">
        <div>
          <div class="small" id="modalMeta">‚Äî</div>
          <h3 style="margin:6px 0 0" id="modalTitle">Livro</h3>
          <div class="chips" style="margin-top:8px" id="modalChips"></div>
        </div>
        <button class="x" id="btnClose">Fechar</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script>
    const $ = (q, el=document)=> el.querySelector(q);
    const $$ = (q, el=document)=> Array.from(el.querySelectorAll(q));

    function pct(x){ return Math.round((Number(x)||0)*100); }

    const __NF = (typeof Intl!=="undefined" && Intl.NumberFormat) ? new Intl.NumberFormat("pt-BR") : null;
    function fmtInt(n){
      n = Number(n||0);
      if(!Number.isFinite(n)) n = 0;
      n = Math.round(n);
      return __NF ? __NF.format(n) : String(n);
    }
    function fmtDateShort(iso){
      if(!iso) return null;
      try{
        const d = new Date(iso);
        return d.toLocaleDateString("pt-BR");
      }catch(_){ return null; }
    }

    // ===== Corrige strings ‚ÄúB√É¬°sica‚Äù (UTF-8 lido como Latin-1) quando acontecer =====
    function fixMojibake(s){
      if(typeof s !== "string") return s;
      if(!/[√É√Ç]/.test(s)) return s;
      try{
        const bytes = Uint8Array.from([...s].map(ch => ch.charCodeAt(0) & 0xFF));
        const decoded = new TextDecoder("utf-8", { fatal:false }).decode(bytes);
        const bad = (s.match(/[√É√Ç]/g)||[]).length;
        const bad2 = (decoded.match(/[√É√Ç]/g)||[]).length;
        const accents = (decoded.match(/[√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á]/g)||[]).length;
        if(bad2 < bad || accents > 0) return decoded;
      }catch(e){}
      return s;
    }
    function txt(s){ return fixMojibake(String(s ?? "")); }

    function escapeHtml(s){
      s = txt(s);
      return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    }
    function minutesToH(min){
      min = Math.max(0, Math.round(Number(min)||0));
      const h = Math.floor(min/60), m = min%60;
      if(h<=0) return `${m}m`;
      if(m===0) return `${h}h`;
      return `${h}h${String(m).padStart(2,"0")}`;
    }

    function coverStyle(cover){
      const A = cover?.colorA || "rgba(106,168,255,.75)";
      const B = cover?.colorB || "rgba(180,140,255,.75)";
      const preset = cover?.preset || "aurora";
      const style = (()=> {
        switch(preset){
          case "grid":
            return `
              background-image:
                repeating-linear-gradient(0deg, rgba(255,255,255,.10) 0 1px, transparent 1px 18px),
                repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 1px, transparent 1px 18px),
                radial-gradient(160px 110px at 20% 25%, rgba(255,255,255,.16), transparent 60%),
                linear-gradient(135deg, ${A}, ${B});
            `;
          case "rings":
            return `
              background-image:
                radial-gradient(circle at 30% 35%, rgba(255,255,255,.14) 0 18%, transparent 19% 100%),
                radial-gradient(circle at 70% 50%, rgba(255,255,255,.11) 0 14%, transparent 15% 100%),
                radial-gradient(circle at 50% 70%, rgba(255,255,255,.10) 0 16%, transparent 17% 100%),
                linear-gradient(135deg, ${A}, ${B});
            `;
          case "rays":
            return `
              background-image:
                conic-gradient(from 210deg at 30% 40%, rgba(255,255,255,.18), rgba(255,255,255,0) 25%, rgba(255,255,255,.14) 50%, rgba(255,255,255,0) 70%, rgba(255,255,255,.12)),
                radial-gradient(140px 90px at 80% 25%, rgba(255,255,255,.16), transparent 62%),
                linear-gradient(135deg, ${A}, ${B});
            `;
          case "waves":
            return `
              background-image:
                radial-gradient(120px 70px at 25% 60%, rgba(255,255,255,.14), transparent 65%),
                radial-gradient(160px 90px at 65% 30%, rgba(255,255,255,.12), transparent 70%),
                radial-gradient(180px 120px at 90% 90%, rgba(255,255,255,.10), transparent 65%),
                linear-gradient(135deg, ${A}, ${B});
            `;
          case "aurora":
          default:
            return `
              background-image:
                radial-gradient(160px 100px at 20% 25%, rgba(255,255,255,.18), transparent 60%),
                radial-gradient(180px 120px at 80% 20%, rgba(255,255,255,.14), transparent 62%),
                radial-gradient(140px 90px at 70% 85%, rgba(255,255,255,.10), transparent 65%),
                linear-gradient(135deg, ${A}, ${B});
            `;
        }
      })();
      return style;
    }

    let DATA = null;

    function setStatus(text, kind="warn"){
      const el = $("#statusChip");
      if(!el) return;
      if(!text){
        el.style.display = "none";
        return;
      }
      el.style.display = "inline-flex";
      el.textContent = text;
      el.classList.remove("warn","good","bad");
      if(kind==="good") el.classList.add("good");
      if(kind==="bad") el.classList.add("bad");
      if(kind==="warn") el.classList.add("warn");
    }

    async function tryFetchPublic(){
      try{
        const url = "./public.json?ts=" + Date.now();
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok) throw new Error("fetch not ok");
        const buf = await r.arrayBuffer();
        const text = new TextDecoder("utf-8", { fatal:false }).decode(new Uint8Array(buf));
        return JSON.parse(text);
      }catch(e){
        return null;
      }
    }

    function computeTagOptions(books){
      const set = new Set();
      books.forEach(b=> (b.tags||[]).forEach(t=> set.add(txt(String(t).trim()))) );
      const tags = Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b));
      const sel = $("#tagFilter");
      sel.innerHTML = `<option value="">(todas as tags)</option>` + tags.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
    }

    // ========= FIX PRINCIPAL: trava altura do card de conquistas igual ao card de perfil =========
    let _syncRaf = 0;
    function syncAchievementPanel(){
      cancelAnimationFrame(_syncRaf);
      _syncRaf = requestAnimationFrame(()=>{
        const pc = $("#profileCard");
        const ac = $("#achCard");
        if(!pc || !ac) return;

        if(window.matchMedia("(max-width: 980px)").matches){
          ac.style.height = "auto";
          ac.style.maxHeight = "none";
          return;
        }

        const target = Math.round(pc.getBoundingClientRect().height);
        ac.style.height = target + "px";
        ac.style.maxHeight = target + "px";
      });
    }

    let _ro = null;
    function setupAchievementObserver(){
      const pc = $("#profileCard");
      if(!pc || _ro) return;
      _ro = new ResizeObserver(()=> syncAchievementPanel());
      _ro.observe(pc);
    }

    function renderProfile(){
      const p = DATA.profile || {};
      const st = DATA.stats || {};
      const ranks = DATA.ranks || {};
      const rb = ranks.byBooks || {};
      const rm = ranks.byMedals || {};

      $("#playerName").textContent = txt(p.name || "Jogador");
      $("#rankTitle").textContent = txt(p.title || "‚Äî");
      $("#tagline").textContent = txt((p.tagline||"").trim() ? p.tagline : "‚Äî");
      $("#medalsChip").innerHTML = `üèÖ <b>${escapeHtml(rm.medals ?? 0)}</b>`;
      $("#rankBooks").textContent = `üìö Rank: ${txt(rb.rank || "‚Äî")}`;
      $("#rankMedals").textContent = `üèµÔ∏è Medalhas: ${txt(rm.rank || "‚Äî")}`;

      const goal = Number(p.annualGoal||0);
      const fin = Number(st.booksFinished||0);
      $("#goalChip").textContent = goal>0 ? `üéØ Meta: ${fin}/${goal}` : "üéØ Meta: ‚Äî";

      const a = p.avatar || {type:"icon", icon:"user"};
      const box = $("#avatarBox");
      box.innerHTML = "";
      if(a.type==="image" && a.image){
        const img = document.createElement("img");
        img.src = a.image;
        img.onload = ()=> syncAchievementPanel();
        box.appendChild(img);
      }else{
        const map = {
          user:"üë§", star:"‚≠ê", book:"üìò", bolt:"‚ö°", flame:"üî•", crown:"üëë",
          sword:"üó°Ô∏è", shield:"üõ°Ô∏è", gem:"üíé", scroll:"üìú", skull:"üíÄ"
        };
        box.textContent = map[a.icon] || "üë§";
      }

      const stats = [
  ["üìö Livros", `${st.booksTotal ?? 0}`],
  ["‚úÖ Finalizados", `${st.booksFinished ?? 0}`],
  ["üìñ Em progresso", `${st.booksInProgress ?? 0}`],
  ["üî• Sequ√™ncia", `${st.streakCurrent ?? 0}d (maior ${st.streakBest ?? 0})`],
  ["üèπ Maior sess√£o", (st.bestSessionMinutes!=null ? minutesToH(st.bestSessionMinutes) : "‚Äî")],
  ["‚è±Ô∏è Tempo total", minutesToH(st.totalMinutes ?? 0)],
];
      $("#statGrid").innerHTML = stats.map(([k,v])=>`
        <div class="stat"><div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v)}</div></div>
      `).join("");

      // ===== Quest√µes (opcional) =====
      const qs = DATA.questionStats || null;
      const qGrid = $("#qStatGrid");
      if(qGrid){
        if(qs && (qs.total!=null || qs.attempted!=null || qs.correct!=null || qs.wrong!=null)){
          const totalQ = Number(qs.total||0) || 0;
          const attempted = Number(qs.attempted||0) || 0;
          const correct = Number(qs.correct||0) || 0;
          const wrong = Number(qs.wrong||0) || 0;
          const denom = correct + wrong;
          const accRaw = (qs.accuracy===0 || qs.accuracy) ? Number(qs.accuracy) : (denom ? (correct/denom) : 0);
          const accPct = denom ? Math.round(Math.max(0, Math.min(1, accRaw)) * 100) : null;

          const cards = [
            ["üì¶ Banco de quest√µes", fmtInt(totalQ)],
            ["‚úÖ Resolvidas", fmtInt(attempted)],
            ["üéØ Acerto", (accPct==null ? "‚Äî" : `${accPct}%`)]
          ];

          qGrid.style.display = "";
          qGrid.innerHTML = cards.map(([k,v])=>`
            <div class="stat small"><div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v)}</div></div>
          `).join("");
        }else{
          qGrid.style.display = "none";
          qGrid.innerHTML = "";
        }
      }


      $("#booksLine").textContent = `${rb.finishedBooks ?? 0} finalizados`;
      $("#booksBar").style.width = `${pct(rb.progress ?? 0)}%`;
      $("#booksPct").textContent = `${pct(rb.progress ?? 0)}%`;
      $("#booksNote").textContent = rb.nextLabel ? `Pr√≥ximo: ${txt(rb.nextLabel)}` : "Max.";

      $("#medalsLine").textContent = `${rm.medals ?? 0} medalhas`;
      $("#medalsBar").style.width = `${pct(rm.progress ?? 0)}%`;
      $("#medalsPct").textContent = `${pct(rm.progress ?? 0)}%`;
      $("#medalsNote").textContent = rm.nextLabel ? `Pr√≥ximo: ${txt(rm.nextLabel)}` : "Max.";

      syncAchievementPanel();
    }

    // ======= Conquistas: biblioteca interna + merge com public.json =======
    function buildAutoAchievementLibrary(data){
      const defs = [];

      const bookMilestones = [
        { n:1, name:"Primeiro livro", medals:2 },
        { n:3, name:"Bronze (3 livros)", medals:3 },
        { n:5, name:"Prata (5 livros)", medals:5 },
        { n:10, name:"Ouro (10 livros)", medals:8 },
        { n:20, name:"Mestre (20 livros)", medals:12 },
        { n:50, name:"Diamante (50 livros)", medals:20 },
        { n:100, name:"Lend√°rio (100 livros)", medals:35 },
      ];
      bookMilestones.forEach(m=>{
        defs.push({ id:`books_${m.n}`, name:`üìö ${m.name}`, desc:`Finalize ${m.n} livro(s).`, medals:m.medals, kind:"auto" });
      });

      const topicMilestones = [
        { n:1, medals:1 }, { n:50, medals:3 }, { n:100, medals:5 },
        { n:250, medals:8 }, { n:500, medals:12 }, { n:1000, medals:20 }
      ];
      topicMilestones.forEach(m=>{
        defs.push({ id:`topics_${m.n}`, name:`‚úÖ T√≥picos: ${m.n}`, desc:`Conclua ${m.n} t√≥pico(s).`, medals:m.medals, kind:"auto" });
      });

      const streakMilestones = [
        { n:3, medals:3 }, { n:7, medals:5 }, { n:14, medals:8 },
        { n:30, medals:12 }, { n:60, medals:20 }
      ];
      streakMilestones.forEach(m=>{
        defs.push({ id:`streak_${m.n}`, name:`üî• Streak: ${m.n} dias`, desc:`Estude por ${m.n} dias seguidos (qualquer atividade).`, medals:m.medals, kind:"auto" });
      });

      const sessionMilestones = [
        { n:60, name:"1h seguida", medals:3 },
        { n:180, name:"3h seguida", medals:8 },
        { n:240, name:"4h seguida", medals:12 },
        { n:360, name:"6h seguida", medals:18 },
      ];
      sessionMilestones.forEach(m=>{
        defs.push({ id:`session_${m.n}`, name:`‚è±Ô∏è Sess√£o: ${m.name}`, desc:`Registre uma sess√£o de ${m.n} minutos ou mais.`, medals:m.medals, kind:"auto" });
      });

      const totalMilestones = [
        { n:600, name:"10h total", medals:5 },
        { n:1800, name:"30h total", medals:12 },
        { n:6000, name:"100h total", medals:28 },
      ];
      totalMilestones.forEach(m=>{
        defs.push({ id:`time_${m.n}`, name:`üß† ${m.name}`, desc:`Some ${m.n} minutos de estudo registrados.`, medals:m.medals, kind:"auto" });
      });

      const tagMap = new Map();
      (data.books||[]).forEach(b=>{
        (b.tags||[]).forEach(t=>{
          const raw = txt(String(t||"").trim());
          const low = raw.toLowerCase();
          if(!raw) return;
          if(!tagMap.has(low)) tagMap.set(low, raw);
        });
      });

      const tagMilestones = [3,5,10,20];
      for(const [low, display] of tagMap.entries()){
        tagMilestones.forEach(n=>{
          defs.push({
            id:`tag_${low}_${n}`,
            name:`üè∑Ô∏è ${display}: ${n} livros`,
            desc:`Finalize ${n} livros com a tag ‚Äú${display}‚Äù.`,
            medals: n===3?4 : n===5?6 : n===10?10 : 18,
            kind:"auto"
          });
        });
      }

      const keyOrder = (id)=>{
        if(id.startsWith("books_")) return 1;
        if(id.startsWith("topics_")) return 2;
        if(id.startsWith("streak_")) return 3;
        if(id.startsWith("session_")) return 4;
        if(id.startsWith("time_")) return 5;
        if(id.startsWith("tag_")) return 6;
        return 9;
      };
      defs.sort((a,b)=>{
        const ka = keyOrder(a.id), kb = keyOrder(b.id);
        if(ka!==kb) return ka-kb;
        return a.name.localeCompare(b.name);
      });

      return defs;
    }

    function renderAchievements(){
      const filter = $("#achFilter").value;

      const unlockedArr = (DATA.achievements?.autoUnlocked || []);
      const unlockedMap = new Map(unlockedArr.map(a=>[a.id, a]));

      const lib = buildAutoAchievementLibrary(DATA);
      const rows = [];

      const libIds = new Set();
      lib.forEach(def=>{
        libIds.add(def.id);
        const got = unlockedMap.get(def.id);
        const isUnlocked = !!got;
        const medals = isUnlocked ? (Number(got.medals)||0) : (Number(def.medals)||0);
        rows.push({
          type:"auto",
          id:def.id,
          title:def.name,
          desc:def.desc,
          medals,
          status:isUnlocked ? "Destravada" : "Bloqueada",
          when:isUnlocked ? (got.unlockedAt || null) : null,
          badgeClass:isUnlocked ? "good" : "warn",
          unlocked:isUnlocked
        });
      });

      unlockedArr.forEach(a=>{
        if(libIds.has(a.id)) return;
        rows.push({
          type:"auto",
          id:a.id,
          title:a.name || a.id,
          desc:a.desc || "Conquista (id desconhecido nesta vitrine).",
          medals:Number(a.medals)||0,
          status:"Destravada",
          when:a.unlockedAt || null,
          badgeClass:"good",
          unlocked:true
        });
      });

      const manual = (DATA.achievements?.manual || []);
      manual.forEach(m=>{
        const done = !!m.completed;
        rows.push({
          type:"manual",
          id:m.id,
          title:`üõ†Ô∏è ${m.title || "Conquista manual"}`,
          desc:(m.desc||"") + (m.difficulty ? ` ‚Ä¢ Dificuldade: ${m.difficulty}` : ""),
          medals:Number(m.medals)||0,
          status:done ? "Conclu√≠da" : "Pendente",
          when:done ? (m.completedAt || null) : null,
          badgeClass: done ? "good" : "warn",
          unlocked: done
        });
      });

      let filtered = rows;
      if(filter==="unlocked") filtered = rows.filter(r=>r.unlocked);
      if(filter==="locked") filtered = rows.filter(r=>!r.unlocked);

      if(filtered.length===0){
        $("#achList").innerHTML = `<div class="empty">Sem conquistas para mostrar (ainda). Finalize livros, conclua t√≥picos e registre sess√µes no QUEST.</div>`;
        syncAchievementPanel();
        return;
      }

      const fmt = (iso)=>{
        if(!iso) return null;
        try{ return new Date(iso).toLocaleDateString("pt-BR"); }catch{ return null; }
      };

      filtered.sort((a,b)=>{
        if(a.unlocked!==b.unlocked) return (b.unlocked?1:0) - (a.unlocked?1:0);
        const ad = a.when || "";
        const bd = b.when || "";
        if(ad!==bd) return String(bd).localeCompare(String(ad));
        return a.title.localeCompare(b.title);
      });

      $("#achList").innerHTML = filtered.map(r=>{
        const when = fmt(r.when);
        const typeTag = r.type==="manual" ? `<span class="tag">üõ†Ô∏è manual</span>` : `<span class="tag">‚öôÔ∏è auto</span>`;
        return `
          <div class="ach">
            <b>${escapeHtml(r.title)}</b>
            <div class="d">${escapeHtml(r.desc || "")}</div>
            <div class="meta">
              <span class="chip good">üèÖ ${escapeHtml(r.medals)}</span>
              <span class="badge ${r.badgeClass}">${escapeHtml(r.status)}</span>
              ${when ? `<span class="tag">üìÖ ${escapeHtml(when)}</span>` : ``}
              ${typeTag}
            </div>
          </div>
        `;
      }).join("");

      syncAchievementPanel();
    }

    function renderSessions(){
      const card = $("#activityCard");
      if(!card) return;

      const reading = Array.isArray(DATA.sessions) ? DATA.sessions.slice(0,20) : [];
      const recentQ = Array.isArray(DATA.recentQuestions) ? DATA.recentQuestions.slice(0,20) : [];
      const themes = Array.isArray(DATA.questionThemes30d) ? DATA.questionThemes30d.slice(0,5) : [];

      if(reading.length===0 && recentQ.length===0){
        card.style.display = "none";
        return;
      }
      card.style.display = "block";

      // ---- Left: reading sessions ----
      const booksById = new Map((DATA.books||[]).map(b=>[b.id,b]));
      const rCount = $("#readingCount");
      if(rCount) rCount.textContent = reading.length ? `${reading.length} registro(s)` : "‚Äî";
      const rList = $("#readingList");
      if(rList){
        if(reading.length===0){
          rList.innerHTML = `<div class="empty">Nenhuma sess√£o de leitura exportada ainda.</div>`;
        }else{
          rList.innerHTML = reading.map(s=>{
            const b = booksById.get(s.bookId);
            const name = b ? b.title : (s.bookId ? "Livro removido" : "Sem livro");
            const d = s.end ? (new Date(s.end).toLocaleDateString("pt-BR")) : "";
            const note = (s.note||"").trim();
            return `
              <div class="ach">
                <b>‚è±Ô∏è ${escapeHtml(minutesToH(s.minutes))} ‚Ä¢ ${escapeHtml(name)}</b>
                <div class="d">${escapeHtml(note ? note : "‚Äî")}</div>
                <div class="meta">
                  <span class="tag">üìÖ ${escapeHtml(d || "‚Äî")}</span>
                  <span class="chip">üß≠ ${escapeHtml(s.bookId ? "Vinculada" : "Livre")}</span>
                </div>
              </div>
            `;
          }).join("");
        }
      }

      // ---- Right: themes (30d) ----
      const qThemesRow = $("#qThemesRow");
      if(qThemesRow){
        if(themes.length===0){
          qThemesRow.style.display = "none";
          qThemesRow.innerHTML = "";
        }else{
          qThemesRow.style.display = "";
          qThemesRow.innerHTML = themes.map(t=>{
            const acc = (t.accuracy===0 || t.accuracy) ? Math.round(Math.max(0, Math.min(1, Number(t.accuracy))) * 100) : null;
            const label = `${txt(t.topic || "(sem t√≥pico)")} ‚Ä¢ ${Number(t.count||0)}${acc!=null ? ` ‚Ä¢ ${acc}%` : ""}`;
            return `<span class="tag">${escapeHtml(label)}</span>`;
          }).join("");
        }
      }

      // ---- Right: recent question attempts (somente metadados) ----
      const qList = $("#qRecentList");
      if(qList){
        const fmtDurShortFromSec = (sec)=>{
          if(sec===null || sec===undefined || !Number.isFinite(Number(sec))) return "‚Äî";
          sec = Math.max(0, Math.floor(Number(sec)));
          const hh = Math.floor(sec/3600);
          const mm = Math.floor((sec%3600)/60);
          const ss = sec%60;
          if(hh>0) return `${hh}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
          return `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
        };

        if(recentQ.length===0){
          qList.innerHTML = `<div class="empty">Nenhuma quest√£o resolvida exportada ainda.</div>`;
        }else{
          qList.innerHTML = recentQ.map(r=>{
            const ok = String(r.result||"") === "ok";
            const icon = ok ? "‚úÖ" : "‚ùå";
            const subj = (r.subject||"").trim() || "Quest√µes";
            const topic = (r.topic||"").trim() || "(sem t√≥pico)";
            const diff = (r.difficulty||"").trim();
            const book = (r.bookTitle||"").trim();
            const d = r.at ? (new Date(r.at).toLocaleDateString("pt-BR")) : "‚Äî";
            const dur = fmtDurShortFromSec(r.durationSec);

            const meta = [
              `<span class="tag">‚è±Ô∏è ${escapeHtml(dur)}</span>`,
              `<span class="tag">üìÖ ${escapeHtml(d)}</span>`,
              diff ? `<span class="tag">‚öîÔ∏è ${escapeHtml(diff)}</span>` : "",
              book ? `<span class="chip">üìò ${escapeHtml(book)}</span>` : ""
            ].filter(Boolean).join("");

            return `
              <div class="ach">
                <b>${icon} ${escapeHtml(subj)} ‚Ä¢ ${escapeHtml(topic)}</b>
                <div class="d">${ok ? "Acertou" : "Errou"}</div>
                <div class="meta">${meta}</div>
              </div>
            `;
          }).join("");
        }
      }
    }


    function openBookModal(book){
      $("#modalTitle").textContent = txt(book.title || "Livro");
      const metaParts = [];
      if(book.author) metaParts.push(`por ${txt(book.author)}`);
      if(book.finished && book.finishedAt){
        try{ metaParts.push(`finalizado em ${new Date(book.finishedAt).toLocaleDateString("pt-BR")}`); }catch{}
      }
      $("#modalMeta").textContent = metaParts.length ? metaParts.join(" ‚Ä¢ ") : "‚Äî";

      const chips = [];
      chips.push(`<span class="chip">${book.finished ? "‚úÖ Finalizado" : "üìñ Em progresso"}</span>`);
      chips.push(`<span class="chip good">üß© ${escapeHtml(book.progress.topicsDone)}/${escapeHtml(book.progress.topicsTotal)}</span>`);
      chips.push(`<span class="chip">üìö ${escapeHtml(book.progress.chaptersDone)}/${escapeHtml(book.progress.chaptersTotal)} cap.</span>`);
      if(book.stars) chips.push(`<span class="chip gold">${"‚≠ê".repeat(book.stars)}</span>`);
      (book.tags||[]).slice(0,8).forEach(t=> chips.push(`<span class="chip">#${escapeHtml(t)}</span>`));
      $("#modalChips").innerHTML = chips.join("");

      const parts = [];
      parts.push(`<div class="bar"><i style="width:${book.progress.percent}%"></i></div>`);
      parts.push(`<div class="barLabel"><span class="muted">Progresso</span><span class="muted">${book.progress.percent}%</span></div>`);

      parts.push(`<div class="hr"></div>`);
      parts.push(`<b>üìå Detalhes</b>`);
      parts.push(`
        <div class="ach" style="margin-top:10px;">
          <b>üß© T√≥picos</b>
          <div class="d">${escapeHtml(book.progress.topicsDone)} conclu√≠dos de ${escapeHtml(book.progress.topicsTotal)}</div>
          <div class="meta"><span class="tag">‚öîÔ∏è ${escapeHtml(book.progress.topicsTotal - book.progress.topicsDone)} restantes</span></div>
        </div>
        <div class="ach" style="margin-top:10px;">
          <b>üìö Cap√≠tulos</b>
          <div class="d">${escapeHtml(book.progress.chaptersDone)} conclu√≠dos de ${escapeHtml(book.progress.chaptersTotal)}</div>
          <div class="meta"><span class="tag">üìñ ${escapeHtml(book.progress.chaptersTotal - book.progress.chaptersDone)} restantes</span></div>
        </div>
      `);

      // ===== BookStats (opcional / leve) =====
      const bs = book.bookStats || null;
      if(bs){
        const readingMin = Number(bs.readingMinTotal||0) || 0;
        const qMin = (bs.questionsMinTotal===0 || bs.questionsMinTotal) ? (Number(bs.questionsMinTotal)||0) : null;
        const last = bs.lastActivityAt ? fmtDateShort(bs.lastActivityAt) : null;

        parts.push(`<div class="hr"></div>`);
        parts.push(`<b>üìä Atividade</b>`);
        const statRows = [];
        statRows.push(`<div class="stat small"><div class="k">üìñ Leitura</div><div class="v">${escapeHtml(minutesToH(readingMin))}</div></div>`);
        if(qMin!=null && qMin>0) statRows.push(`<div class="stat small"><div class="k">üß© Quest√µes</div><div class="v">${escapeHtml(minutesToH(qMin))}</div></div>`);
        if(last) statRows.push(`<div class="stat small"><div class="k">üïò √öltima</div><div class="v">${escapeHtml(last)}</div></div>`);
        parts.push(`<div class="statGrid" style="margin-top:10px; grid-template-columns:repeat(3,1fr);">${statRows.join("")}</div>`);

        const chs = Array.isArray(bs.chapters) ? bs.chapters : [];
        if(chs.length){
          parts.push(`<div class="hr"></div>`);
          parts.push(`<b>üìë Cap√≠tulos</b>`);
          parts.push(`<div class="small" style="margin-top:6px;">${escapeHtml(fmtInt(chs.length))} cap√≠tulo(s) ‚Ä¢ status por t√≥picos conclu√≠dos.</div>`);

          const items = chs.map(ch=>{
            const title = txt(ch?.title || "Cap√≠tulo");
            const totalTopics = Number(ch?.totalTopics||0) || 0;
            const doneTopics = Number(ch?.doneTopics||0) || 0;
            const completed = !!ch?.completed;

            const p = totalTopics ? Math.round((doneTopics/totalTopics)*100) : 0;
            const badge = completed
              ? `<span class="badge good">Conclu√≠do</span>`
              : (doneTopics>0
                  ? `<span class="badge warn">${p}%</span>`
                  : `<span class="badge">Novo</span>`);

            return `
              <div class="chItem">
                <div class="chTop">
                  <div style="min-width:0;">
                    <div class="chTitle">${escapeHtml(title)}</div>
                    <div class="chSub">${escapeHtml(fmtInt(doneTopics))}/${escapeHtml(fmtInt(totalTopics))} t√≥picos</div>
                  </div>
                  <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end">${badge}</div>
                </div>
              </div>
            `;
          }).join("");

          parts.push(`<div class="chList">${items}</div>`);
        }
      }

      if(book.finished){
        const review = txt((book.review||"").trim());
        parts.push(`<div class="hr"></div>`);
        parts.push(`<b>üìù Review</b>`);
        parts.push(review ? `<div class="review" style="margin-top:8px;">${escapeHtml(review)}</div>` : `<div class="small" style="margin-top:8px;">Sem review.</div>`);
      }else{
        parts.push(`<div class="hr"></div>`);
        parts.push(`<div class="small">Estrelas/tags/review podem ser ajustados ao finalizar o livro no QUEST.</div>`);
      }

      $("#modalBody").innerHTML = parts.join("");
      $("#backdrop").style.display = "flex";
    }

    function renderBooks(){
      const books = DATA.books || [];
      const mode = $("#bookFilter").value;
      const tag = $("#tagFilter").value;

      let filtered = books.slice();
      if(mode==="progress") filtered = filtered.filter(b=>!b.finished);
      if(mode==="done") filtered = filtered.filter(b=>b.finished);
      if(tag) filtered = filtered.filter(b=>(b.tags||[]).map(x=>txt(String(x))).includes(tag));

      $("#collectionCount").textContent = `${filtered.length} livro(s)`;

      if(filtered.length===0){
        $("#bookGrid").innerHTML = `<div class="empty" style="grid-column:1/-1;">Sem livros para este filtro.</div>`;
        return;
      }

      $("#bookGrid").innerHTML = filtered.map(b=>{
        const cover = coverStyle(b.cover);
        const tags = (b.tags||[]).slice(0,4).map(t=>`<span class="tag">#${escapeHtml(t)}</span>`).join("");
        const meta = b.author ? txt(b.author) : "‚Äî";
        const badge = b.finished ? `<span class="badge good">Finalizado</span>` : `<span class="badge warn">${b.progress.percent}%</span>`;
        const stars = b.stars ? `<span class="badge">${"‚≠ê".repeat(b.stars)}</span>` : "";
        const review = b.review ? `<span class="badge">üìù review</span>` : "";
        return `
          <div class="book" data-book="${escapeHtml(b.id)}">
            <div class="cover" style="${cover}"></div>
            <div class="bookBody">
              <div class="row">
                <p class="bookTitle">${escapeHtml(b.title)}</p>
                <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">${badge}${stars}${review}</div>
              </div>
              <p class="bookMeta">${escapeHtml(meta)}</p>
              <div class="bar"><i style="width:${b.progress.percent}%"></i></div>
              <div class="miniRow"><span>${escapeHtml(b.progress.topicsDone)}/${escapeHtml(b.progress.topicsTotal)} t√≥picos</span><span>${escapeHtml(b.progress.chaptersDone)}/${escapeHtml(b.progress.chaptersTotal)} cap.</span></div>
              ${tags ? `<div class="tagRow">${tags}</div>` : ``}
            </div>
          </div>
        `;
      }).join("");

      $$(".book", $("#bookGrid")).forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.dataset.book;
          const b = books.find(x=>x.id===id);
          if(b) openBookModal(b);
        });
      });
    }

    function bindUI(){
      $("#btnClose").onclick = ()=> $("#backdrop").style.display = "none";
      $("#backdrop").addEventListener("click", (e)=>{ if(e.target.id==="backdrop") $("#backdrop").style.display="none"; });

      $("#bookFilter").onchange = renderBooks;
      $("#tagFilter").onchange = renderBooks;
      $("#achFilter").onchange = renderAchievements;

      window.addEventListener("resize", ()=> syncAchievementPanel());
      window.addEventListener("load", ()=> syncAchievementPanel());
    }

    function loadData(j){
      DATA = j;
      if(!DATA || !DATA.meta || DATA.meta.schema !== "public.v1"){
        setStatus("public.json inv√°lido (schema).", "bad");
        return;
      }

      setStatus("");

      renderProfile();
      computeTagOptions(DATA.books||[]);
      renderBooks();
      renderAchievements();
      renderSessions();

      setupAchievementObserver();
      syncAchievementPanel();
    }

    bindUI();

    // Fallback: se abrir pelo disco (file://), o fetch do public.json costuma falhar.
    // Ent√£o oferecemos carregamento manual via seletor de arquivo.
    (function(){
      const inp = $("#localPublicFile");
      const chip = $("#loadLocalChip");
      if(!inp || !chip) return;
      inp.addEventListener("change", async (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        try{
          const text = await f.text();
          const j = JSON.parse(text);
          chip.style.display = "none";
          loadData(j);
          setStatus("", "good");
        }catch(err){
          console.error(err);
          setStatus("Falha ao ler este public.json.", "bad");
        }finally{
          e.target.value = "";
        }
      });
      chip.addEventListener("click", ()=> inp.click());
    })();

    (async ()=>{
      setStatus("Carregando public.json‚Ä¶", "warn");

      const j = await tryFetchPublic();
      if(j){
        loadData(j);
      }else{
        setStatus("public.json n√£o encontrado nesta pasta.", "bad");
        const lc = $("#loadLocalChip"); if(lc) lc.style.display = "inline-flex";
        DATA = { meta:{schema:"public.v1"}, profile:{}, ranks:{}, stats:{}, achievements:{autoUnlocked:[],manual:[]}, sessions:[], books:[] };
        renderProfile();
        computeTagOptions([]);
        renderBooks();
        renderAchievements();
        renderSessions();
        setupAchievementObserver();
        syncAchievementPanel();
      }
    })();
  </script>
</body>
</html>
